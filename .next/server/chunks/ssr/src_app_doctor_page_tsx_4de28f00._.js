module.exports=[58912,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(10849),e=a.i(60246),f=a.i(35126),g=a.i(35599),h=a.i(4720),i=a.i(16201),j=a.i(62722),k=a.i(70106);let l=(0,k.default)("Printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]);var m=a.i(14548),n=a.i(91965),o=a.i(15618);let p=(0,k.default)("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);var q=a.i(41993),r=a.i(2927);function s(){let[a,k]=(0,c.useState)([]),[s,u]=(0,c.useState)(""),[v,w]=(0,c.useState)([]),[x,y]=(0,c.useState)(null),[z,A]=(0,c.useState)({reason:"",conclusion:""}),[B,C]=(0,c.useState)([]),[D,E]=(0,c.useState)([]),[F,G]=(0,c.useState)([]),[H,I]=(0,c.useState)([]),[J,K]=(0,c.useState)(!1),[L,M]=(0,c.useState)(null),[N,O]=(0,c.useState)(!1);async function P(){let{data:a}=await d.supabase.from("service_catalog").select("name").eq("is_active",!0).neq("name","Khám bệnh").order("name");a&&I(a.map(a=>a.name))}async function Q(){let{data:a}=await d.supabase.from("staff").select("*").eq("role","Doctor").eq("is_active",!0);a&&k(a)}async function R(){let{data:a}=await d.supabase.from("visits").select("*, patient:patients(*)").eq("doctor_by",s).eq("status","Examing");a&&1===a.length?(T(a[0]),M({type:"success",text:`Đ\xe3 kh\xf4i phục phi\xean kh\xe1m của ${a[0].patient?.full_name}`})):a&&a.length>1&&M({type:"success",text:`Đang c\xf3 ${a.length} bệnh nh\xe2n đang kh\xe1m dở. Vui l\xf2ng chọn từ danh s\xe1ch.`})}async function S(){let{data:a,error:b}=await d.supabase.from("medications").select("*").eq("is_active",!0).order("name");b&&(console.error("Error fetching active meds, trying all...",b),a=(await d.supabase.from("medications").select("*").order("name")).data),a&&G(a)}async function T(a){if(!s)return void M({type:"error",text:"Vui lòng chọn Tên Bác sĩ trước khi gọi bệnh nhân!"});y(a),A({reason:a.reason||"",conclusion:a.conclusion||""}),C([]);let{data:b}=await d.supabase.from("prescriptions").select("*").eq("visit_id",a.id).single();b?w(b.medication_data):w([]);let{data:c}=await d.supabase.from("services").select("*").eq("visit_id",a.id).in("status",["Completed","Skipped"]);c?E(c):E([]),await d.supabase.from("visits").update({status:"Examing",doctor_by:s}).eq("id",a.id)}async function U(){if(!x||0===B.length)return;K(!0);let a=B.map(a=>({visit_id:x.id,service_type:a,status:"Pending"})),{error:b}=await d.supabase.from("services").insert(a);b?M({type:"error",text:"Có lỗi xảy ra khi lưu chỉ định."}):(await d.supabase.from("visits").update({status:"Waiting for Service",reason:z.reason}).eq("id",x.id),M({type:"success",text:`Đ\xe3 chỉ định ${B.length} dịch vụ th\xe0nh c\xf4ng!`}),C([]),y(null)),K(!1)}async function V(){if(!x)return!1;try{let{error:a}=await d.supabase.from("visits").update({reason:z.reason,conclusion:z.conclusion,doctor_by:s}).eq("id",x.id);if(a)throw a;if(v.length>0){let a,{data:b}=await d.supabase.from("prescriptions").select("id").eq("visit_id",x.id).single();if(b){let{error:b}=await d.supabase.from("prescriptions").update({medication_data:v}).eq("visit_id",x.id);a=b}else{let{error:b}=await d.supabase.from("prescriptions").insert([{visit_id:x.id,medication_data:v}]);a=b}if(a)throw a}return!0}catch(a){return M({type:"error",text:"Lỗi lưu dữ liệu: "+a.message}),!1}}async function W(){s?(K(!0),await V()&&M({type:"success",text:"Đã lưu dữ liệu khám bệnh."}),K(!1)):M({type:"error",text:"Vui lòng chọn bác sĩ."})}async function X(){s?(K(!0),await V()&&window.open(`/print/prescription/${x?.id}`,"_blank"),K(!1)):M({type:"error",text:"Vui lòng chọn bác sĩ."})}async function Y(){if(x&&confirm("Hoàn tất lượt khám và chuyển bệnh nhân sang thanh toán?")){if(K(!0),await V()){let{error:a}=await d.supabase.from("visits").update({status:"Ready for Payment"}).eq("id",x.id);a?M({type:"error",text:"Lỗi cập nhật trạng thái."}):(M({type:"success",text:"Đã hoàn tất lượt khám. Chuyển thanh toán."}),y(null))}K(!1)}}async function Z(){x&&(await d.supabase.from("visits").update({status:"Missed"}).eq("id",x.id),y(null),M({type:"success",text:"Đã đánh dấu bệnh nhân vắng mặt."}))}return(0,c.useEffect)(()=>{Q(),S(),P()},[]),(0,c.useEffect)(()=>{s&&R()},[s]),(0,c.useEffect)(()=>{if(L){let a=setTimeout(()=>M(null),3e3);return()=>clearTimeout(a)}},[L]),(0,b.jsxs)("div",{className:"container mx-auto p-4 flex flex-col h-screen max-h-screen overflow-hidden relative",children:[(0,b.jsxs)("header",{className:"mb-4 flex justify-between items-center shrink-0",children:[(0,b.jsxs)("h1",{className:"text-2xl font-bold text-primary flex items-center gap-2",children:[(0,b.jsx)(f.Stethoscope,{})," Phân hệ Bác sĩ"]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("label",{className:"text-sm font-medium",children:"Bác sĩ khám:"}),(0,b.jsxs)("select",{className:"border p-1.5 rounded-md bg-white text-sm",value:s,onChange:a=>u(a.target.value),children:[(0,b.jsx)("option",{value:"",children:"-- Chọn bác sĩ --"}),a.map(a=>(0,b.jsx)("option",{value:a.name,children:a.name},a.id))]})]})]}),(0,b.jsxs)("div",{className:"flex gap-4 flex-1 overflow-hidden",children:[(0,b.jsxs)("div",{className:"w-80 flex flex-col gap-4 overflow-y-auto shrink-0 pr-2",children:[(0,b.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border p-3",children:[(0,b.jsxs)("h3",{className:"text-sm font-bold mb-2 text-gray-500 uppercase flex items-center gap-1",children:[(0,b.jsx)(e.Users,{size:14})," Hàng đợi khám"]}),s&&(0,b.jsx)(r.default,{status:"Examing",title:"Đang khám (Của tôi)",onSelect:T,filterDoctor:s}),(0,b.jsx)("div",{className:"mt-4",children:(0,b.jsx)(r.default,{status:"Waiting for Exam",title:"Khám mới",onSelect:T})}),(0,b.jsx)("div",{className:"mt-4",children:(0,b.jsx)(r.default,{status:"Return to Doctor",title:"Quay lại (Có KQ)",onSelect:T})})]}),(0,b.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border p-3 mt-auto",children:[(0,b.jsxs)("h3",{className:"text-sm font-bold mb-2 text-gray-500 uppercase flex items-center gap-1",children:[(0,b.jsx)(n.History,{size:14})," Bệnh nhân vừa khám"]}),(0,b.jsx)("div",{className:"flex-1 overflow-y-auto min-h-0",children:s?(0,b.jsx)(r.default,{status:"Ready for Payment",title:"Chờ t.toán (Vừa xong)",onSelect:T,filterDoctor:s}):(0,b.jsx)("p",{className:"text-xs text-gray-400 text-center italic mt-4",children:"Chọn bác sĩ để xem lịch sử"})})]})]}),(0,b.jsx)("div",{className:"flex-1 bg-white rounded-xl border shadow-sm flex flex-col overflow-hidden",children:x?(0,b.jsxs)("div",{className:"flex flex-col h-full",children:[(0,b.jsxs)("div",{className:"p-4 border-b flex justify-between items-center bg-blue-50/30",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h2",{className:"text-lg font-bold text-gray-800",children:x.patient?.full_name}),(0,b.jsxs)("div",{className:"text-xs text-gray-500 flex gap-4",children:[(0,b.jsxs)("span",{children:["CCCD: ",x.patient?.cccd]}),(0,b.jsxs)("span",{children:["Tuổi: ",x.patient?.dob?new Date().getFullYear()-new Date(x.patient.dob).getFullYear():"N/A"]}),(0,b.jsxs)("span",{children:["GT: ",x.patient?.gender]})]})]}),(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsxs)("button",{onClick:Z,className:"p-2 text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-1 text-sm border border-red-100",children:[(0,b.jsx)(j.XCircle,{size:16})," Vắng mặt"]}),(0,b.jsxs)("button",{onClick:()=>O(!0),className:"p-2 text-blue-600 hover:bg-blue-50 rounded-lg flex items-center gap-1 text-sm border border-blue-100",children:[(0,b.jsx)(n.History,{size:16})," Xem bệnh sử"]})]})]}),(0,b.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-6",children:[(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-bold text-gray-600 mb-1",children:"Lý do khám / Triệu chứng"}),(0,b.jsx)("textarea",{className:"w-full border rounded-lg p-3 h-24 focus:ring-2 focus:ring-primary outline-none",value:z.reason,onChange:a=>A({...z,reason:a.target.value})})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"block text-sm font-bold text-gray-600 mb-1",children:"Kết luận / Chẩn đoán"}),(0,b.jsx)("textarea",{className:"w-full border rounded-lg p-3 h-24 focus:ring-2 focus:ring-primary outline-none",value:z.conclusion,onChange:a=>A({...z,conclusion:a.target.value})})]})]}),(0,b.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4 border border-dashed border-gray-300",children:[(0,b.jsxs)("h3",{className:"text-sm font-bold text-gray-700 mb-3 flex items-center gap-2",children:[(0,b.jsx)(g.Beaker,{size:16})," Chỉ định cận lâm sàng"]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:[0===H.length&&(0,b.jsx)("p",{className:"text-sm text-gray-500 italic col-span-3",children:"Đang tải danh sách dịch vụ..."}),H.map(a=>(0,b.jsxs)("label",{className:"flex items-center gap-2 bg-white border p-3 rounded-lg cursor-pointer hover:border-primary transition-colors",children:[(0,b.jsx)("input",{type:"checkbox",className:"w-4 h-4 text-primary rounded focus:ring-primary",checked:B.includes(a),onChange:b=>{b.target.checked?C([...B,a]):C(B.filter(b=>b!==a))}}),(0,b.jsx)("span",{className:"text-sm font-medium",children:a})]},a))]}),B.length>0&&(0,b.jsx)("div",{className:"mt-3 flex justify-end",children:(0,b.jsxs)("button",{onClick:U,disabled:J,className:"bg-primary text-white text-sm px-4 py-2 rounded-lg hover:bg-blue-600 transition-all flex items-center gap-2 shadow-sm",children:[(0,b.jsx)(o.Plus,{size:16})," Chỉ định ",B.length," dịch vụ đã chọn"]})})]}),D.length>0&&(0,b.jsxs)("div",{className:"bg-green-50 rounded-lg p-4 border border-green-200 animate-in fade-in slide-in-from-bottom-5",children:[(0,b.jsxs)("h3",{className:"text-sm font-bold text-green-800 mb-3 flex items-center gap-2",children:[(0,b.jsx)(i.CheckCircle,{size:16})," Kết quả Cận lâm sàng"]}),(0,b.jsx)("div",{className:"grid grid-cols-1 gap-4",children:D.map(a=>(0,b.jsxs)("div",{className:"bg-white p-4 rounded-lg border border-green-100 shadow-sm flex gap-4",children:[a.image_url&&(0,b.jsxs)("div",{className:"shrink-0 flex flex-col items-center gap-1",children:[(0,b.jsx)("a",{href:a.image_url,target:"_blank",rel:"noopener noreferrer",className:"block",children:(0,b.jsx)("img",{src:a.image_url,alt:"Kết quả",className:"w-32 h-32 object-cover rounded-lg border hover:opacity-90 transition-opacity bg-gray-100",onError:a=>{a.target.src="https://placehold.co/150?text=Lỗi+Ảnh",a.target.style.objectFit="contain"}})}),(0,b.jsxs)("a",{href:a.image_url,target:"_blank",rel:"noopener noreferrer",className:"text-[10px] text-blue-600 hover:underline flex items-center gap-1",children:[(0,b.jsx)(p,{size:10})," Xem ảnh gốc"]})]}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,b.jsx)("span",{className:"font-bold text-gray-800",children:a.service_type}),(0,b.jsxs)("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full border border-green-200",children:["Thực hiện bởi: ",a.tech_by]})]}),(0,b.jsx)("p",{className:"text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 p-2 rounded border border-gray-100",children:a.result_text||"Chưa có mô tả kết quả."})]})]},a.id))})]}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("h3",{className:"text-sm font-bold text-gray-700 mb-2 flex items-center gap-2",children:[(0,b.jsx)(h.FileText,{size:16})," Kê đơn thuốc"]}),(0,b.jsxs)("div",{className:"space-y-2",children:[v.map((a,c)=>(0,b.jsxs)("div",{className:"flex gap-2 items-center bg-white p-2 border rounded-lg animate-in slide-in-from-left-2 duration-200",children:[(0,b.jsx)("input",{list:"meds",placeholder:"Tên thuốc...",className:"flex-[2] border-none focus:ring-0 text-sm",value:a.name,onChange:a=>{let b=[...v];b[c].name=a.target.value,w(b)}}),(0,b.jsx)("input",{placeholder:"Liều dùng (VD: 2v/ngày)",className:"flex-[1] border-none focus:ring-0 text-sm italic text-gray-500",value:a.dose,onChange:a=>{let b=[...v];b[c].dose=a.target.value,w(b)}}),(0,b.jsx)("input",{placeholder:"Số lượng",className:"w-20 border-none focus:ring-0 text-sm text-center font-bold",value:a.qty,onChange:a=>{let b=[...v];b[c].qty=a.target.value,w(b)}}),(0,b.jsx)("button",{onClick:()=>w(v.filter((a,b)=>b!==c)),className:"p-1 text-gray-300 hover:text-red-500",children:(0,b.jsx)(j.XCircle,{size:16})})]},c)),(0,b.jsxs)("button",{onClick:()=>w([...v,{name:"",dose:"",qty:""}]),className:"text-primary text-sm flex items-center gap-1 hover:underline p-1",children:[(0,b.jsx)(o.Plus,{size:14})," Thêm thuốc"]}),(0,b.jsx)("datalist",{id:"meds",children:F.map(a=>(0,b.jsx)("option",{value:a.name},a.id))})]})]})]}),(0,b.jsxs)("div",{className:"p-4 border-t bg-gray-50 flex justify-between items-center shrink-0",children:[(0,b.jsx)("div",{className:"flex gap-2",children:(0,b.jsxs)("button",{onClick:W,disabled:J,className:"bg-white border border-gray-200 px-4 py-2 rounded-lg hover:border-primary hover:text-primary transition-all flex items-center gap-2",children:[(0,b.jsx)(m.Save,{size:18})," Lưu Nháp"]})}),(0,b.jsxs)("div",{className:"flex gap-3",children:[(0,b.jsxs)("button",{onClick:X,disabled:J,className:"bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100 transition-all flex items-center gap-2 shadow-sm",children:[(0,b.jsx)(l,{size:18})," In Đơn Thuốc"]}),(0,b.jsxs)("button",{onClick:Y,disabled:J||!s,className:"bg-primary text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-all flex items-center gap-2 shadow-md shadow-blue-200 disabled:opacity-50",children:[(0,b.jsx)(i.CheckCircle,{size:18})," Hoàn tất Khám"]})]})]})]}):(0,b.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-400 bg-gray-50/50",children:[(0,b.jsx)(f.Stethoscope,{size:48,strokeWidth:1,className:"mb-2"}),(0,b.jsx)("p",{children:"Chọn một bệnh nhân từ hàng đợi để bắt đầu khám"})]})})]}),L&&(0,b.jsxs)("div",{className:`fixed top-4 right-4 p-4 rounded-xl shadow-lg flex items-center gap-3 animate-in slide-in-from-top-5 z-50 cursor-pointer ${"success"===L.type?"bg-green-600 text-white":"bg-red-600 text-white"}`,onClick:()=>M(null),children:["success"===L.type?(0,b.jsx)(i.CheckCircle,{size:20}):(0,b.jsx)(t,{size:20}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("p",{className:"font-medium",children:L.text}),(0,b.jsx)("p",{className:"text-xs opacity-80 mt-1",children:"Bấm để đóng"})]}),(0,b.jsx)(j.XCircle,{size:18,className:"opacity-50 hover:opacity-100"})]}),N&&x?.patient&&(0,b.jsx)(q.default,{patient:x.patient,onClose:()=>O(!1)})]})}function t({size:a}){return(0,b.jsx)(j.XCircle,{size:a})}a.s(["default",()=>s],58912)}];

//# sourceMappingURL=src_app_doctor_page_tsx_4de28f00._.js.map